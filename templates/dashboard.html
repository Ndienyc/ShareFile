{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å ‚Äî –§–∞–π–ª–æ–æ–±–º–µ–Ω–Ω–∏–∫{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <h2>üëã –ü—Ä–∏–≤–µ—Ç, {{ username }}!</h2>
    <p style="color: var(--text-secondary);">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–∞–π–ª–∞–º–∏ –∏ –¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–∞–º–∏.</p>
</div>

{% if new_link %}
<div class="auth-box" style="margin-bottom: 30px; border: 2px solid var(--success); background: #f0fdf4;">
    <h3 style="color: var(--success); margin-bottom: 10px;">‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!</h3>
    <p style="margin-bottom: 10px;">–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:</p>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" value="{{ new_link }}" readonly
               id="new-link-input"
               style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: var(--radius-md); background: white; font-family: monospace; color: var(--text-primary);">
        <button onclick="copyLink(document.getElementById('new-link-input').value)"
                class="btn btn-primary" style="width: auto; white-space: nowrap;">
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å üìã
        </button>
    </div>

    {% if qr_code_data %}
    <div style="text-align: center; margin-top: 15px;">
        <p style="margin-bottom: 8px; color: var(--text-secondary);">–ò–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥:</p>
        <img src="data:image/png;base64,{{ qr_code_data }}" alt="QR Code" style="width: 160px; height: 160px; border: 1px solid #cbd5e1; border-radius: 8px;">
    </div>
    {% endif %}
</div>
{% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="dashboard-grid">
    <div class="auth-box">
        <h3 style="margin-bottom: 20px; color: var(--text-primary);">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                <label for="file-upload" class="custom-file-upload" id="file-label">
                    üìÇ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                </label>
                <input id="file-upload" type="file" name="file" required onchange="updateFileName(this)">
            </div>
            <div class="form-group">
                <label for="pin_code">PIN-–∫–æ–¥</label>
                <input type="text" id="pin_code" name="pin_code" minlength="4" required placeholder="–ú–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞">
            </div>
            <div class="form-group">
                <label for="download_limit">–õ–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π</label>
                <input type="number" id="download_limit" name="download_limit" min="1" max="100" value="5" required>
            </div>
            <div class="form-group">
                <label style="display: flex; gap: 12px; cursor: pointer; align-items: flex-start;">
                    <input type="checkbox" name="auto_delete" value="1" style="width: 20px; height: 20px; accent-color: var(--primary); margin-top: 2px;">
                    <div>
                        <span style="font-weight: 600; color: var(--text-primary);">–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ª–∏–º–∏—Ç–∞</span>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">–§–∞–π–ª —É–¥–∞–ª–∏—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ª–∏–º–∏—Ç–∞.</p>
                    </div>
                </label>
            </div>
            <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å üöÄ</button>
        </form>
    </div>

    <div class="auth-box">
        <h3 style="margin-bottom: 20px; color: var(--text-primary);">üìÅ –ú–æ–∏ —Ñ–∞–π–ª—ã</h3>
        {% if files %}
        <div class="file-table-container">
            <table>
                <thead>
                    <tr>
                        <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                        <th style="text-align: center;">–õ–∏–º–∏—Ç</th>
                        <th style="text-align: center;">–ê–≤—Ç–æ—É–¥.</th>
                        <th style="text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in files %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ f.filename }}">{{ f.filename }}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">{{ f.created_at }}</div>
                        </td>
                        <td style="text-align: center;">
                            <span style="background: var(--bg-main); padding: 4px 10px; border-radius: 100px; font-size: 12px; border: 1px solid #e2e8f0;">
                                {{ f.download_count }} / {{ f.download_limit }}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            {{ '‚úÖ' if f.auto_delete else '<span style="color:#cbd5e1">‚úñÔ∏è</span>'|safe }}
                        </td>
                        <td style="text-align: right; white-space: nowrap;">
                            <button type="button" onclick="copyLink('{{ request.url_root }}f/{{ f.token }}')" class="action-btn btn-icon-copy">üîó</button>
                            <a href="{{ f.download_url }}" target="_blank" class="action-btn btn-icon-dl">‚¨áÔ∏è</a>
                            <button type="button" onclick="showQR('{{ url_for('generate_qr', token=f.token) }}', '{{ f.filename }}')" class="action-btn" style="background: none; border: none; font-size: 18px; cursor: pointer;">üì±</button>
                            <form method="POST" action="{{ url_for('delete_file', token=f.token) }}" style="display: inline-block;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å?');">
                                <button class="action-btn btn-icon-del">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted); border: 2px dashed #e2e8f0; border-radius: var(--radius-md);">
            <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
            <p>–§–∞–π–ª–æ–≤ –Ω–µ—Ç</p>
        </div>
        {% endif %}
    </div>
</div>

<div id="qrModal" class="auth-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 320px; padding: 24px; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
    <div style="text-align: center;">
        <h3 id="qrFilename" style="margin: 0 0 16px; font-size: 16px; font-weight: 600; color: var(--text-primary); word-break: break-all;"></h3>
        <img id="qrImage" src="" alt="QR Code" style="width: 240px; height: 240px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 16px;">
        <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</p>
    </div>
    <button onclick="closeQRModal()" style="margin-top: 16px; width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="qrOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;" onclick="closeQRModal()"></div>

<script>
    function updateFileName(input) {
        var label = document.getElementById('file-label');
        if (input.files && input.files.length > 0) {
            label.innerHTML = 'üìÑ ' + input.files[0].name;
            label.style.borderColor = 'var(--primary)';
            label.style.color = 'var(--text-primary)';
            label.style.fontWeight = '600';
        } else {
            label.innerHTML = 'üìÇ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª';
        }
    }

    function copyLink(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(() => fallbackCopy(text));
        } else {
            fallbackCopy(text);
        }
    }
    function fallbackCopy(text) {
        try {
            var ta = document.createElement("textarea");
            ta.value = text; ta.style.position = "fixed"; document.body.appendChild(ta);
            ta.focus(); ta.select();
            document.execCommand('copy') ? alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!') : prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ:", text);
            document.body.removeChild(ta);
        } catch (err) { prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ:", text); }
    }

    function showQR(qrUrl, filename) {
        document.getElementById('qrFilename').textContent = filename;
        document.getElementById('qrImage').src = qrUrl;
        document.getElementById('qrModal').style.display = 'block';
        document.getElementById('qrOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeQRModal() {
        document.getElementById('qrModal').style.display = 'none';
        document.getElementById('qrOverlay').style.display = 'none';
        document.body.style.overflow = '';
    }
</script>
{% endblock %}