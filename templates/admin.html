{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h2>üîê –ê–¥–º–∏–Ω-—Ü–µ–Ω—Ç—Ä</h2>
        <p style="color: var(--text-secondary);">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-primary" style="width: auto;">‚Üê –í –∫–∞–±–∏–Ω–µ—Ç</a>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 40px;">
    <div class="auth-box" style="padding: 24px; text-align: center; border-bottom: 4px solid var(--primary);">
        <div style="font-size: 32px; margin-bottom: 8px;">üë•</div>
        <h3 style="font-size: 36px; color: var(--text-primary); margin-bottom: 4px;">{{ stats.users }}</h3>
        <p style="color: var(--text-muted); font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    </div>
    <div class="auth-box" style="padding: 24px; text-align: center; border-bottom: 4px solid var(--secondary);">
        <div style="font-size: 32px; margin-bottom: 8px;">üìÅ</div>
        <h3 style="font-size: 36px; color: var(--text-primary); margin-bottom: 4px;">{{ stats.files }}</h3>
        <p style="color: var(--text-muted); font-weight: 600;">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</p>
    </div>
    <div class="auth-box" style="padding: 24px; text-align: center; border-bottom: 4px solid var(--success);">
        <div style="font-size: 32px; margin-bottom: 8px;">‚¨áÔ∏è</div>
        <h3 style="font-size: 36px; color: var(--text-primary); margin-bottom: 4px;">{{ stats.downloads }}</h3>
        <p style="color: var(--text-muted); font-weight: 600;">–°–∫–∞—á–∏–≤–∞–Ω–∏–π</p>
    </div>
</div>

<div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
    <div class="auth-box">
        <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div class="file-table-container" style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
            <table>
                <thead>
                    <tr>
                        <th>–õ–æ–≥–∏–Ω</th>
                        <th style="text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td style="font-weight: 600;">
                            {{ u }}
                            {% if u == 'admin' %}
                            <span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">ADMIN</span>
                            {% endif %}
                        </td>
                        <td style="text-align: right;">
                            {% if u != 'admin' %}
                            <form method="POST" action="{{ url_for('delete_user_route', username=u) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ —Ñ–∞–π–ª—ã?');">
                                <button class="action-btn btn-icon-del" title="–ë–∞–Ω">‚ùå</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="auth-box">
        <h3>üóÑÔ∏è –í—Å–µ —Ñ–∞–π–ª—ã</h3>
        <div class="file-table-container" style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
            <table>
                <thead>
                    <tr>
                        <th>–§–∞–π–ª</th>
                        <th style="text-align: center;">–ò–Ω—Ñ–æ</th>
                        <th style="text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in files %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ f.filename }}</div>
                            <div style="font-size: 11px; color: var(--primary);">üë§ {{ f.uploader }}</div>
                        </td>
                        <td style="text-align: center; font-size: 12px;">
                            {{ f.download_count }}/{{ f.download_limit }}
                        </td>
                        <td style="text-align: right;">
                            <button type="button" onclick="copyLink('{{ f.download_url }}')" class="action-btn btn-icon-copy">üîó</button>
                            <a href="{{ f.download_url }}" target="_blank" class="action-btn btn-icon-dl">‚¨áÔ∏è</a>
                            <button type="button" onclick="showQR('{{ url_for('generate_qr', token=f.token) }}', '{{ f.filename }}')" class="action-btn" style="background: none; border: none; font-size: 18px; cursor: pointer;">üì±</button>
                            <form method="POST" action="{{ url_for('delete_file', token=f.token) }}" style="display: inline-block;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?');">
                                <button class="action-btn btn-icon-del">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="qrModal" class="auth-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 320px; padding: 24px; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
    <div style="text-align: center;">
        <h3 id="qrFilename" style="margin: 0 0 16px; font-size: 16px; font-weight: 600; color: var(--text-primary); word-break: break-all;"></h3>
        <img id="qrImage" src="" alt="QR Code" style="width: 240px; height: 240px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 16px;">
        <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</p>
    </div>
    <button onclick="closeQRModal()" style="margin-top: 16px; width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="qrOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;" onclick="closeQRModal()"></div>

<script>
    function copyLink(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(() => fallbackCopy(text));
        } else {
            fallbackCopy(text);
        }
    }
    function fallbackCopy(text) {
        try {
            var ta = document.createElement("textarea");
            ta.value = text; ta.style.position = "fixed"; document.body.appendChild(ta);
            ta.focus(); ta.select();
            document.execCommand('copy') ? alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!') : prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ:", text);
            document.body.removeChild(ta);
        } catch (err) { prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ:", text); }
    }

    function showQR(qrUrl, filename) {
        document.getElementById('qrFilename').textContent = filename;
        document.getElementById('qrImage').src = qrUrl;
        document.getElementById('qrModal').style.display = 'block';
        document.getElementById('qrOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeQRModal() {
        document.getElementById('qrModal').style.display = 'none';
        document.getElementById('qrOverlay').style.display = 'none';
        document.body.style.overflow = '';
    }
</script>
{% endblock %}